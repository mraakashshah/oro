---
date: 2026-02-20
status: partial
---

goal: >
  Closed oro-owx0 (Dashboard Wave 3 epic). Decomposed two epics via
  adversarial spec review: oro-q5p0 (memory system, 6 beads) and
  oro-ihda (build system, 5 beads). Fixed missing oro-search-hook
  binary. No implementation code written — pure planning session.

now: >
  Two epics ready for execution. Start with oro-ihda.1 (ORO_HOME default)
  and oro-q5p0.1 + oro-q5p0.5 (Consolidate testonly + Embedder mutex)
  since they're all independent leaf beads. Set parent epics to
  in_progress before starting children (bd auto-blocks children on parent).

test: go test ./pkg/memory/ ./pkg/dispatcher/ ./cmd/oro/ -race -count=1

done_this_session:
  - task: "Closed oro-owx0: Dashboard Wave 3 epic"
    details: "All 6 children already closed, blocker oro-ycjj resolved."

  - task: "Decomposed oro-q5p0 into 6 beads with adversarial review"
    details: >
      Deep codebase exploration found epic description stale (ForPrompt
      already wired in 3 dispatcher sites, Consolidate already auto-runs).
      Adversarial review found 3 critical gaps: Embedder has no mutex
      (concurrent map panic), worker-side Store lacks embedder, vocab
      lost on restart. Added .5 (mutex) and .6 (vocab persistence).
    files: []

  - task: "Decomposed oro-ihda (build fixes) into 5 beads with adversarial review"
    details: >
      Premortem found build system has no single correct path. Adversarial
      review found Fix 3 (move output path) breaks repo-local settings.json,
      Fix 2 (ensureSearchHook) hard-fails outside repo. Revised all fixes.
    files: []

  - task: "Fixed missing oro-search-hook binary"
    details: "Built via go build -o .claude/hooks/oro-search-hook. Root cause: make build didn't build companion binaries."
    files: [Makefile]

  - task: "Filed oro-nb7p: DB split bug"
    details: "CLI defaultMemoryStore() uses memories.db but dispatcher uses state.db."

decisions:
  - mutex_before_embedder: >
      Embedder.vocab has no sync protection. Must add mutex (oro-q5p0.5)
      BEFORE wiring embedder into production (oro-q5p0.2), otherwise
      concurrent map writes cause fatal panic.
  - build_during_init_not_start: >
      ensureSearchHook should run during oro init (which has repo access),
      not oro start (which may run from any directory). oro start just
      checks binary exists.
  - dual_output_paths: >
      make build must output to BOTH .claude/hooks/ (for interactive
      Claude Code) and ~/.oro/hooks/ (for workers/tmux). Two settings.json
      files reference different paths.
  - vocab_persistence_separate: >
      Embedder vocab is ephemeral (lost on restart). Made this a P2 bead
      (.6) since HybridSearch degrades gracefully to FTS5 via RRF. Not
      a blocker for initial wiring.

findings:
  - two_settings_json: >
      .claude/settings.json (repo, relative paths, checked into git) and
      ~/.oro/projects/<name>/settings.json (generated by oro init, absolute
      paths). They drift independently — repo has enforce-skills.sh and
      notify_manager hooks; generated does not.
  - ensureSearchHook_is_dead_code: >
      cmd/oro/preflight.go:40 — function exists, is tested, but never
      called from any production code path.
  - forprompt_already_wired: >
      ForPrompt() has 3 production call sites in dispatcher. Epic
      description claiming "never called" is stale.
  - embedder_thread_safety: >
      Embedder.vocab is plain map[string]int. Concurrent Embed() calls
      from dispatcher goroutines will cause fatal runtime panic.
  - worker_store_no_embedder: >
      cmd_worker.go creates memory.NewStore(db) without SetEmbedder.
      Worker-inserted memories get NULL embeddings.
  - registerer_searches_by_id: >
      worker_pool.go:86 passes bead ID not title to ForPrompt. FTS5
      searching for "oro-q5p0" matches nothing useful. Pre-existing bug.

worked:
  - "Fresh-context subagent for adversarial spec review — found gaps the decomposer missed"
  - "Premortem before filing beads — caught the two-settings-json problem early"
  - "Deep codebase exploration before decomposition — found stale epic assumptions"

failed:
  - "Initial make build fix only output to .claude/hooks/ — adversarial review caught this would break workers"

next:
  - "Set parent epics to in_progress: bd update oro-q5p0 --status=in_progress && bd update oro-ihda --status=in_progress"
  - "Execute leaf beads in parallel: oro-ihda.1, oro-q5p0.1, oro-q5p0.5"
  - "Then unblocked wave: oro-ihda.2/.3/.4 and oro-q5p0.2"
  - "Then final wave: oro-ihda.5, oro-q5p0.3/.4/.6"
  - "Commit the Makefile change (already modified, adds companion binary builds to make build)"

beads:
  completed: [oro-owx0]
  in_progress: []
  remaining:
    - epic: oro-q5p0
      children:
        - oro-q5p0.1   # Remove testonly from Consolidate (ready)
        - oro-q5p0.5   # Add mutex to Embedder (ready)
        - oro-q5p0.2   # Wire embedder in production (blocked by .5)
        - oro-q5p0.3   # Switch ForPrompt to HybridSearch (blocked by .2)
        - oro-q5p0.4   # Integration test (blocked by .2)
        - oro-q5p0.6   # Vocab persistence (P2, blocked by .2)
    - epic: oro-ihda
      children:
        - oro-ihda.1   # ORO_HOME default (ready)
        - oro-ihda.2   # Build during init, verify in start (blocked by .1)
        - oro-ihda.3   # Dual output paths (blocked by .1)
        - oro-ihda.4   # Asset version stamp (blocked by .1)
        - oro-ihda.5   # Settings.json SSOT (P2, blocked by .3)
    - standalone:
        - oro-nb7p     # DB split CLI vs dispatcher (P2)

learnings:
  undocumented:
    - "Two settings.json files exist and drift independently (oro-ihda, hook, json, git)"
    - "ensureSearchHook fail-closes on missing srcDir — breaks go install users (oro-ihda, go)"
    - "Embedder.vocab has no mutex — concurrent map panic when wired to production (oro-q5p0.5, memory, go)"
    - "ForPrompt already wired in 3 dispatcher call sites — epic description stale (oro-q5p0, memory)"
    - "CLI uses memories.db but dispatcher uses state.db — two different DBs (oro-nb7p, cli, go)"
    - "registerWorker passes bead ID not title to ForPrompt — pre-existing search quality bug (memory)"
