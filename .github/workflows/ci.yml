name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  go:
    name: Go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      # Stage assets for go:embed (required for build/lint/test)
      - name: Stage assets
        run: make stage-assets
        env:
          ORO_HOME: ${{ github.workspace }}/.oro-ci

      # Tier 1: Formatting
      - name: gofumpt
        run: |
          go install mvdan.cc/gofumpt@latest
          test -z "$(gofumpt -l cmd internal pkg)"

      - name: goimports
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          test -z "$(goimports -l cmd internal pkg)"

      # Tier 2: Linting
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          args: --timeout 5m ./cmd/... ./internal/... ./pkg/...

      # Tier 3: Architecture
      - name: go-arch-lint
        run: |
          go install github.com/fe3dback/go-arch-lint@latest
          go-arch-lint check --project-path .

      # Tier 4: Testing + Coverage (85% minimum)
      - name: Install ast-grep
        run: npm install -g @ast-grep/cli

      - name: Test + Coverage
        run: |
          go test -race -shuffle=on -coverprofile=coverage.out ./internal/... ./pkg/... ./cmd/...
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          awk "BEGIN {exit ($COVERAGE < 85)}"

      # Tier 5: Security
      - name: govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      # Tier 6: Build
      - name: Build
        run: go build ./...

      - name: Vet
        run: go vet ./...

      # Clean up staged assets
      - name: Clean assets
        if: always()
        run: make clean-assets

  shell:
    name: Shell
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: shellcheck
        run: find . -name '*.sh' -not -path './references/*' -not -path './yap/*' -not -path './archive/*' -not -path './.worktrees/*' -exec shellcheck --severity=info {} +

  docs:
    name: Docs & Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install JS tools
        run: npm ci

      - name: markdownlint
        run: |
          npx markdownlint-cli2 --config .markdownlint.yml \
            "docs/**/*.md" "*.md" "!references/**" "!yap/**" "!archive/**"

      - name: yamllint
        run: |
          pip install yamllint
          find . \( -name '*.yml' -o -name '*.yaml' \) \
            -not -path './references/*' -not -path './yap/*' \
            -not -path './archive/*' -not -path './.worktrees/*' \
            -not -path './node_modules/*' | xargs yamllint -d relaxed --no-warnings

      - name: biome (json)
        run: npx biome check --files-ignore-unknown=true docs/ .github/ .beads/ *.json

  python:
    name: Python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      # Tier 1: Formatting
      - name: ruff format
        run: uvx ruff format --check .

      # Tier 2: Linting
      - name: ruff check
        run: uvx ruff check .

      - name: pylint (errors only)
        run: |
          find . -name '*.py' -not -path './references/*' -not -path './yap/*' \
            -not -path './archive/*' -not -path './.worktrees/*' -not -path './.venv/*' \
            -not -path './assets/*' -not -path './.claude/*' \
            | xargs uvx pylint --disable=all --enable=E

      # Tier 3: Type checking
      - name: pyright
        run: uvx pyright

      # Tier 4: Testing
      - name: pytest
        run: |
          # Skip tests that require ~/.oro/hooks/ (environment-specific)
          uvx pytest --ignore=tests/test_inject_context_usage.py \
                     --ignore=tests/test_memory_capture.py \
                     --ignore=tests/test_session_start_extras.py \
                     --ignore=tests/test_validate_agent_completion.py \
                     --ignore=tests/test_worktree_guard.py
